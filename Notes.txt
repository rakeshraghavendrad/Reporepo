
from deepeval.metrics import FaithfulnessMetric
from deepeval.test_case import LLMEvalTestCase

# Initialize the metric
faithfulness_metric = FaithfulnessMetric(
    threshold=0.7,
    model=llm_no_ssl,
    include_reason=True
)

# Define the function to apply row-wise
def apply_faithfulness(row):
    test_case = LLMEvalTestCase(
        input="Check if the following output is faithful to the provided context.",
        actual_output=row["evidence_run2"],           # Generated or second response
        retrieval_context=[row["evidence_run1"]]      # Ground truth or original evidence
    )
    faithfulness_metric.measure(test_case)
    return pd.Series({
        "faithfulness_score": faithfulness_metric.score,
        "faithfulness_reason": faithfulness_metric.reason
    })

# Apply the function row by row
df_evidence[["faithfulness_score", "faithfulness_reason"]] = df_evidence.apply(apply_faithfulness, axis=1)
