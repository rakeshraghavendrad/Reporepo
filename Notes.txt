import ast
import pandas as pd

# Step 1: Make sure 'defined_input' column exists
df['defined_input'] = None

# Step 2: Define your keyword and relevant columns
target_keyword = 'Generated summary of compelling evidence'
keyword_column = 'keyword'
input_column = 'input'

# Step 3: Identify matching rows
mask = df[keyword_column].str.contains(target_keyword, case=False, na=False)

# Step 4: Loop through only the matching rows
for idx, row in df[mask].iterrows():
    input_json_string = row[input_column]

    try:
        # Parse JSON
        parsed_json = ast.literal_eval(input_json_string)

        # Get only the 'user' messages
        user_contents = [item['content'] for item in parsed_json if item.get('role') == 'user']

        # Format output
        output_parts = []
        for i, content in enumerate(user_contents[:3]):
            output_parts.append(f"{i+1}. {content}")

        overall = "\n".join(output_parts)

        # Assign to new column
        df.loc[idx, 'defined_input'] = overall

    except (ValueError, SyntaxError):
        df.loc[idx, 'defined_input'] = "Invalid JSON"
