from deepeval.metrics import FaithfulnessMetric
from deepeval.test_case import LLMTestCase
import re
import json

# âœ… Patched FaithfulnessMetric with forced JSON-style prompt
class PatchedFaithfulnessMetric(FaithfulnessMetric):
    def _construct_prompt(self, context, output):
        return f"""
Evaluate how faithful the following output is to the given context.

Return ONLY in this exact JSON format:
{{
  "score": float (between 0 and 1),
  "reason": string
}}

Context:
"{context}"

Output:
"{output}"
"""

# âœ… Inputs
actual_output = "We offer a 30-day full refund at no extra cost."
retrieval_context = ["All customers are eligible for a 30 day full refund at no extra cost."]

# âœ… Metric
metric = PatchedFaithfulnessMetric(
    threshold=0.7,
    model="gemini-2.0-flash-001",
    include_reason=True
)

# âœ… Test Case
test_case = LLMTestCase(
    input="What if these shoes don't fit?",
    actual_output=actual_output,
    retrieval_context=retrieval_context
)

# âœ… Run + Handle JSON + Non-JSON Outputs
try:
    result = metric.measure(test_case)

    # Check if result is dict-like or str
    if isinstance(result, str):
        print("âš ï¸ Received string instead of parsed JSON.")
        print("ğŸ“¤ Raw model response:\n", result)

        # Try to parse JSON if string looks like JSON
        try:
            cleaned = result.strip().strip("```json").strip("`")
            parsed = json.loads(cleaned)
            print("\nâœ… Score:", parsed.get("score", "â“ Not Found"))
            print("ğŸ’¬ Reason:", parsed.get("reason", "â“ Not Found"))
        except:
            # Fallback: extract with regex
            score_match = re.search(r'score\s*(is|of|=)?\s*([0-9]\.?[0-9]*)', result, re.IGNORECASE)
            score = float(score_match.group(2)) if score_match else "â“ Not Found"
            reason = result.split("score")[0].strip().strip('"')
            print("\nğŸ” Extracted (from freeform text):")
            print("âœ… Score:", score)
            print("ğŸ’¬ Reason:", reason)

    else:
        # If metric.score and metric.reason are set, print them
        print("âœ… Score:", getattr(metric, 'score', 'â“ Not Set'))
        print("ğŸ’¬ Reason:", getattr(metric, 'reason', 'â“ Not Set'))

except Exception as e:
    print("âŒ Unexpected error:", e)
